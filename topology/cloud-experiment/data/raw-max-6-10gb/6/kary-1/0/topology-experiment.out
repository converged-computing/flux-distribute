[1;31merror[0m: [1mexternally-managed-environment[0m

[31mÃ—[0m This environment is externally managed
[31mâ•°â”€>[0m To install Python packages system-wide, try apt install
[31m   [0m python3-xyz, where xyz is the package you are trying to
[31m   [0m install.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian-packaged Python package,
[31m   [0m create a virtual environment using python3 -m venv path/to/venv.
[31m   [0m Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
[31m   [0m sure you have python3-full installed.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian packaged Python application,
[31m   [0m it may be easiest to use pipx install xyz, which will manage a
[31m   [0m virtual environment for you. Make sure you have pipx installed.
[31m   [0m 
[31m   [0m See /usr/share/doc/python3.12/README.venv for more information.

[1;35mnote[0m: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
[1;36mhint[0m: See PEP 668 for the detailed specification.
MODULE STATS CONTENT
[1;39m{
  [0m[1;34m"count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"valid"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"dirty"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"size"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"flush-batch-count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"mmap"[0m[1;39m: [0m[1;39m{
    [0m[1;34m"tags"[0m[1;39m: [0m[1;39m{}[0m[1;39m,
    [0m[1;34m"blobs"[0m[1;39m: [0m[0;39m0[0m[1;39m
  [1;39m}[0m[1;39m
[1;39m}[0m
NODES
6
TOPOLOGY diagram
0 flux-sample-0: full
â””â”€ 1 flux-sample-1: full
   â””â”€ 2 flux-sample-2: full
      â””â”€ 3 flux-sample-3: full
         â””â”€ 4 flux-sample-4: full
            â””â”€ 5 flux-sample-5: full
TOPOLOGY description
kary:1
EVENT create-archive-1

real	0m4.033s
user	0m1.471s
sys	0m1.214s
EVENT distribute-all-nodes-1

real	0m2.710s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-1

real	0m0.313s
user	0m0.000s
sys	0m0.007s
EVENT delete-archive-all-nodes-1

real	0m0.029s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-1

real	0m4.036s
user	0m1.489s
sys	0m1.186s
EVENT distribute-leaf-nodes-1

real	0m2.509s
user	0m0.002s
sys	0m0.004s
EVENT clean-leaf-nodes-1

real	0m0.312s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-1

real	0m0.028s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-1

real	0m3.918s
user	0m1.449s
sys	0m1.163s
EVENT distribute-middle-nodes-0-1

real	0m2.591s
user	0m0.002s
sys	0m0.004s
EVENT distribute-middle-nodes-1-1

real	0m2.696s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-1

real	0m0.312s
user	0m0.004s
sys	0m0.002s
EVENT delete-archive-middle-nodes-1

real	0m0.028s
user	0m0.002s
sys	0m0.005s
EVENT create-archive-2

real	0m7.956s
user	0m2.954s
sys	0m2.392s
EVENT distribute-all-nodes-2

real	0m5.279s
user	0m0.004s
sys	0m0.003s
EVENT clean-all-nodes-2

real	0m0.593s
user	0m0.004s
sys	0m0.004s
EVENT delete-archive-all-nodes-2

real	0m0.029s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-2

real	0m7.960s
user	0m2.984s
sys	0m2.250s
EVENT distribute-leaf-nodes-2

real	0m5.003s
user	0m0.001s
sys	0m0.005s
EVENT clean-leaf-nodes-2

real	0m0.594s
user	0m0.005s
sys	0m0.002s
EVENT delete-archive-leaf-nodes-2

real	0m0.029s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-2

real	0m7.918s
user	0m2.915s
sys	0m2.335s
EVENT distribute-middle-nodes-0-2

real	0m5.060s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-2

real	0m5.267s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-2

real	0m0.588s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-2

real	0m0.030s
user	0m0.000s
sys	0m0.007s
EVENT create-archive-3

real	0m11.635s
user	0m4.397s
sys	0m3.345s
EVENT distribute-all-nodes-3

real	0m7.994s
user	0m0.002s
sys	0m0.006s
EVENT clean-all-nodes-3

real	0m0.882s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-3

real	0m0.029s
user	0m0.001s
sys	0m0.005s
EVENT create-leaf-nodes-3

real	0m11.760s
user	0m4.474s
sys	0m3.417s
EVENT distribute-leaf-nodes-3

real	0m7.919s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-3

real	0m0.878s
user	0m0.000s
sys	0m0.007s
EVENT delete-archive-leaf-nodes-3

real	0m0.030s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-3

real	0m11.820s
user	0m4.380s
sys	0m3.496s
EVENT distribute-middle-nodes-0-3

real	0m7.850s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-3

real	0m7.535s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-3

real	0m0.914s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-3

real	0m0.028s
user	0m0.001s
sys	0m0.005s
EVENT create-archive-4

real	0m15.837s
user	0m5.936s
sys	0m4.568s
EVENT distribute-all-nodes-4

real	0m10.622s
user	0m0.003s
sys	0m0.005s
EVENT clean-all-nodes-4

real	0m1.430s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-all-nodes-4

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-leaf-nodes-4

real	0m16.168s
user	0m5.866s
sys	0m4.835s
EVENT distribute-leaf-nodes-4

real	0m10.069s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-4

real	0m1.167s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-4

real	0m0.028s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-4

real	0m15.645s
user	0m5.910s
sys	0m4.555s
EVENT distribute-middle-nodes-0-4

real	0m10.194s
user	0m0.002s
sys	0m0.004s
EVENT distribute-middle-nodes-1-4

real	0m10.561s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-4

real	0m12.998s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-4

real	0m0.029s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-5

real	0m19.716s
user	0m7.291s
sys	0m5.776s
EVENT distribute-all-nodes-5

real	0m13.316s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-5

real	0m1.637s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-5

real	0m0.034s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-5

real	0m19.507s
user	0m7.452s
sys	0m5.622s
EVENT distribute-leaf-nodes-5

real	0m13.287s
user	0m0.002s
sys	0m0.004s
EVENT clean-leaf-nodes-5

real	0m1.453s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-5

real	0m0.034s
user	0m0.003s
sys	0m0.005s
EVENT create-middle-nodes-5

real	0m20.080s
user	0m7.549s
sys	0m5.817s
EVENT distribute-middle-nodes-0-5

real	0m13.407s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-5

real	0m14.073s
user	0m0.004s
sys	0m0.002s
EVENT clean-middle-nodes-5

real	0m11.955s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-5

real	0m0.034s
user	0m0.001s
sys	0m0.007s
EVENT create-archive-6

real	0m23.624s
user	0m8.917s
sys	0m6.854s
EVENT distribute-all-nodes-6

real	0m17.830s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-6

real	0m33.182s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-6

real	0m0.040s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-6

real	0m24.135s
user	0m8.748s
sys	0m7.087s
EVENT distribute-leaf-nodes-6

real	0m16.538s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-6

real	0m2.057s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-6

real	0m0.039s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-6

real	0m23.459s
user	0m8.931s
sys	0m6.614s
EVENT distribute-middle-nodes-0-6

real	0m17.660s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-6

real	0m16.665s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-6

real	0m2.079s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-6

real	0m0.040s
user	0m0.004s
sys	0m0.003s
EVENT create-archive-7

real	0m27.959s
user	0m10.123s
sys	0m8.319s
EVENT distribute-all-nodes-7

real	0m21.506s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-7

real	0m29.708s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-7

real	0m0.042s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-7

real	0m27.675s
user	0m10.311s
sys	0m8.103s
EVENT distribute-leaf-nodes-7

real	0m18.046s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-7

real	0m38.692s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-7

real	0m0.042s
user	0m0.004s
sys	0m0.003s
EVENT create-middle-nodes-7

real	0m27.350s
user	0m10.476s
sys	0m7.733s
EVENT distribute-middle-nodes-0-7

real	0m18.730s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-7

real	0m19.797s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-7

real	0m18.076s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-middle-nodes-7

real	0m0.042s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-8

real	0m31.764s
user	0m11.847s
sys	0m9.385s
EVENT distribute-all-nodes-8

real	0m24.586s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-8

real	0m38.154s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-all-nodes-8

real	0m0.045s
user	0m0.001s
sys	0m0.006s
EVENT create-leaf-nodes-8

real	0m32.077s
user	0m11.833s
sys	0m9.539s
EVENT distribute-leaf-nodes-8

real	0m24.478s
user	0m0.002s
sys	0m0.004s
EVENT clean-leaf-nodes-8

real	0m32.929s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-8

real	0m0.044s
user	0m0.000s
sys	0m0.007s
EVENT create-middle-nodes-8

real	0m31.055s
user	0m11.803s
sys	0m8.923s
EVENT distribute-middle-nodes-0-8

real	0m22.877s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-8

real	0m24.340s
user	0m0.003s
sys	0m0.004s
EVENT clean-middle-nodes-8

real	0m32.967s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-8

real	0m0.048s
user	0m0.005s
sys	0m0.003s
EVENT create-archive-9

real	0m35.153s
user	0m13.195s
sys	0m10.258s
EVENT distribute-all-nodes-9

real	0m29.174s
user	0m0.004s
sys	0m0.004s
EVENT clean-all-nodes-9

real	0m39.090s
user	0m0.004s
sys	0m0.004s
EVENT delete-archive-all-nodes-9

real	0m0.049s
user	0m0.005s
sys	0m0.003s
EVENT create-leaf-nodes-9

real	0m35.484s
user	0m13.265s
sys	0m10.581s
EVENT distribute-leaf-nodes-9

real	0m25.031s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-9

real	0m2.817s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-9

real	0m0.050s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-9

real	0m36.177s
user	0m13.307s
sys	0m10.940s
EVENT distribute-middle-nodes-0-9

real	0m24.773s
user	0m0.001s
sys	0m0.005s
EVENT distribute-middle-nodes-1-9

real	0m27.679s
user	0m0.003s
sys	0m0.004s
EVENT clean-middle-nodes-9

real	0m35.382s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-9

real	0m0.050s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-10

real	0m39.775s
user	0m14.718s
sys	0m12.076s
EVENT distribute-all-nodes-10

real	0m30.724s
user	0m0.001s
sys	0m0.006s
EVENT clean-all-nodes-10

real	0m38.389s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-all-nodes-10

real	0m0.052s
user	0m0.004s
sys	0m0.003s
EVENT create-leaf-nodes-10

real	0m39.475s
user	0m14.748s
sys	0m11.695s
EVENT distribute-leaf-nodes-10

real	0m30.465s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-10

real	0m38.415s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-10

real	0m0.052s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-10

real	0m39.488s
user	0m14.827s
sys	0m11.647s
EVENT distribute-middle-nodes-0-10

real	0m30.898s
user	0m0.000s
sys	0m0.006s
EVENT distribute-middle-nodes-1-10

real	0m28.882s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-10

real	0m3.152s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-middle-nodes-10

real	0m0.052s
user	0m0.003s
sys	0m0.005s
SCRIPT entrypoint

#!/bin/bash
# flux-topology.sh

flux exec -r all flux module reload content purge-target-size=104857600 # 100mb
echo "MODULE STATS CONTENT"
flux module stats content | jq

# Print the overlay to show the topology
echo "NODES"
echo "6"
echo "TOPOLOGY diagram"
flux overlay status
echo "TOPOLOGY description"
echo "kary:1"

# Go up to 10 sizes for now (matches container size)
for size in $(seq 1 10)
  do
    # Create the archive and time it
    echo "EVENT create-archive-${size}"
    time flux archive create --name create-archive-${size} --dir /chonks ${size}gb.txt

    # Distribute to all nodes, but to /tmp because file exists in /chonks
    echo "EVENT distribute-all-nodes-${size}"
    time flux exec -r all -x 0 flux archive extract --name create-archive-${size} -C /tmp

    # Cleanup all archive on all nodes
    echo "EVENT clean-all-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt

    echo "EVENT delete-archive-all-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-${size} 2>/dev/null

    # Next, do the same for the root node (level 0) to the deepest level (leaves)
    echo "EVENT create-leaf-nodes-${size}"
    time flux archive create --name create-archive-leaves-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-leaf-nodes-${size}"
    time flux exec -r 5 -x 0 flux archive extract --name create-archive-leaves-${size} -C /tmp
    # Cleanup again    
    echo "EVENT clean-leaf-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-leaf-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-leaves-${size} 2>/dev/null

    # Finally, get the middle node and distribute to middle level first, then middle to last
    echo "EVENT create-middle-nodes-${size}"
    time flux archive create --name create-archive-middle-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-middle-nodes-0-${size}"
    time flux exec -r 3 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT distribute-middle-nodes-1-${size}"
    time flux exec -r 5 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT clean-middle-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-middle-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-middle-${size} 2>/dev/null
done

# Show self!
echo "SCRIPT entrypoint"
cat $0