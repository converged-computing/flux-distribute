[1;31merror[0m: [1mexternally-managed-environment[0m

[31mÃ—[0m This environment is externally managed
[31mâ•°â”€>[0m To install Python packages system-wide, try apt install
[31m   [0m python3-xyz, where xyz is the package you are trying to
[31m   [0m install.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian-packaged Python package,
[31m   [0m create a virtual environment using python3 -m venv path/to/venv.
[31m   [0m Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
[31m   [0m sure you have python3-full installed.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian packaged Python application,
[31m   [0m it may be easiest to use pipx install xyz, which will manage a
[31m   [0m virtual environment for you. Make sure you have pipx installed.
[31m   [0m 
[31m   [0m See /usr/share/doc/python3.12/README.venv for more information.

[1;35mnote[0m: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
[1;36mhint[0m: See PEP 668 for the detailed specification.
MODULE STATS CONTENT
[1;39m{
  [0m[1;34m"count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"valid"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"dirty"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"size"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"flush-batch-count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"mmap"[0m[1;39m: [0m[1;39m{
    [0m[1;34m"tags"[0m[1;39m: [0m[1;39m{}[0m[1;39m,
    [0m[1;34m"blobs"[0m[1;39m: [0m[0;39m0[0m[1;39m
  [1;39m}[0m[1;39m
[1;39m}[0m
NODES
6
TOPOLOGY diagram
0 flux-sample-0: full
â”œâ”€ 1 flux-sample-1: full
â”œâ”€ 2 flux-sample-2: full
â”‚  â””â”€ 3 flux-sample-3: full
â””â”€ 4 flux-sample-4: full
   â””â”€ 5 flux-sample-5: full
TOPOLOGY description
binomial
EVENT create-archive-1

real	0m4.010s
user	0m1.474s
sys	0m1.187s
EVENT distribute-all-nodes-1

real	0m2.994s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-1

real	0m10.822s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-1

real	0m0.020s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-1

real	0m3.930s
user	0m1.466s
sys	0m1.161s
EVENT distribute-leaf-nodes-1

real	0m2.978s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-1

real	0m8.812s
user	0m0.004s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-1

real	0m0.021s
user	0m0.004s
sys	0m0.003s
EVENT create-middle-nodes-1

real	0m3.897s
user	0m1.452s
sys	0m1.132s
EVENT distribute-middle-nodes-0-1

real	0m3.057s
user	0m0.002s
sys	0m0.004s
EVENT distribute-middle-nodes-1-1

real	0m3.015s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-1

real	0m7.802s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-1

real	0m0.019s
user	0m0.000s
sys	0m0.007s
EVENT create-archive-2

real	0m7.747s
user	0m2.826s
sys	0m2.364s
EVENT distribute-all-nodes-2

real	0m6.436s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-2

real	0m18.336s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-all-nodes-2

real	0m0.022s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-2

real	0m7.790s
user	0m2.945s
sys	0m2.233s
EVENT distribute-leaf-nodes-2

real	0m6.139s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-2

real	0m20.862s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-2

real	0m0.022s
user	0m0.004s
sys	0m0.003s
EVENT create-middle-nodes-2

real	0m7.705s
user	0m2.933s
sys	0m2.218s
EVENT distribute-middle-nodes-0-2

real	0m6.170s
user	0m0.003s
sys	0m0.003s
EVENT distribute-middle-nodes-1-2

real	0m6.033s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-2

real	0m19.836s
user	0m0.002s
sys	0m0.006s
EVENT delete-archive-middle-nodes-2

real	0m0.022s
user	0m0.003s
sys	0m0.005s
EVENT create-archive-3

real	0m11.819s
user	0m4.381s
sys	0m3.452s
EVENT distribute-all-nodes-3

real	0m7.879s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-3

real	0m0.872s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-3

real	0m0.026s
user	0m0.001s
sys	0m0.005s
EVENT create-leaf-nodes-3

real	0m11.713s
user	0m4.503s
sys	0m3.258s
EVENT distribute-leaf-nodes-3

real	0m7.781s
user	0m0.001s
sys	0m0.006s
EVENT clean-leaf-nodes-3

real	0m16.387s
user	0m0.005s
sys	0m0.002s
EVENT delete-archive-leaf-nodes-3

real	0m0.027s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-3

real	0m11.588s
user	0m4.359s
sys	0m3.385s
EVENT distribute-middle-nodes-0-3

real	0m7.766s
user	0m0.001s
sys	0m0.005s
EVENT distribute-middle-nodes-1-3

real	0m7.637s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-3

real	0m1.104s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-3

real	0m0.026s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-4

real	0m16.031s
user	0m5.830s
sys	0m4.714s
EVENT distribute-all-nodes-4

real	0m11.832s
user	0m0.004s
sys	0m0.003s
EVENT clean-all-nodes-4

real	0m17.280s
user	0m0.003s
sys	0m0.003s
EVENT delete-archive-all-nodes-4

real	0m0.028s
user	0m0.001s
sys	0m0.005s
EVENT create-leaf-nodes-4

real	0m15.745s
user	0m5.876s
sys	0m4.616s
EVENT distribute-leaf-nodes-4

real	0m10.564s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-4

real	0m1.157s
user	0m0.004s
sys	0m0.002s
EVENT delete-archive-leaf-nodes-4

real	0m0.028s
user	0m0.003s
sys	0m0.004s
EVENT create-middle-nodes-4

real	0m15.387s
user	0m5.810s
sys	0m4.430s
EVENT distribute-middle-nodes-0-4

real	0m10.328s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-4

real	0m10.435s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-4

real	0m22.204s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-4

real	0m0.029s
user	0m0.002s
sys	0m0.005s
EVENT create-archive-5

real	0m20.029s
user	0m7.509s
sys	0m5.803s
EVENT distribute-all-nodes-5

real	0m13.798s
user	0m0.000s
sys	0m0.007s
EVENT clean-all-nodes-5

real	0m26.015s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-5

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-leaf-nodes-5

real	0m19.584s
user	0m7.360s
sys	0m5.668s
EVENT distribute-leaf-nodes-5

real	0m12.830s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-5

real	0m26.860s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-5

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-5

real	0m19.743s
user	0m7.360s
sys	0m5.861s
EVENT distribute-middle-nodes-0-5

real	0m13.751s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-5

real	0m12.957s
user	0m0.004s
sys	0m0.003s
EVENT clean-middle-nodes-5

real	0m12.860s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-5

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-6

real	0m23.879s
user	0m8.725s
sys	0m7.093s
EVENT distribute-all-nodes-6

real	0m18.282s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-6

real	0m32.613s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-6

real	0m0.033s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-6

real	0m23.178s
user	0m8.901s
sys	0m6.530s
EVENT distribute-leaf-nodes-6

real	0m15.466s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-6

real	0m1.724s
user	0m0.005s
sys	0m0.002s
EVENT delete-archive-leaf-nodes-6

real	0m0.033s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-6

real	0m23.671s
user	0m8.923s
sys	0m6.755s
EVENT distribute-middle-nodes-0-6

real	0m16.925s
user	0m0.004s
sys	0m0.002s
EVENT distribute-middle-nodes-1-6

real	0m16.860s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-6

real	0m2.163s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-middle-nodes-6

real	0m0.033s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-7

real	0m27.641s
user	0m10.288s
sys	0m8.108s
EVENT distribute-all-nodes-7

real	0m21.088s
user	0m0.004s
sys	0m0.003s
EVENT clean-all-nodes-7

real	0m35.620s
user	0m0.005s
sys	0m0.003s
EVENT delete-archive-all-nodes-7

real	0m0.035s
user	0m0.002s
sys	0m0.006s
EVENT create-leaf-nodes-7

real	0m27.401s
user	0m10.219s
sys	0m8.007s
EVENT distribute-leaf-nodes-7

real	0m20.130s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-7

real	0m36.337s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-7

real	0m0.035s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-7

real	0m27.119s
user	0m10.180s
sys	0m7.838s
EVENT distribute-middle-nodes-0-7

real	0m20.218s
user	0m0.004s
sys	0m0.003s
EVENT distribute-middle-nodes-1-7

real	0m19.752s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-7

real	0m36.997s
user	0m0.004s
sys	0m0.004s
EVENT delete-archive-middle-nodes-7

real	0m0.035s
user	0m0.002s
sys	0m0.005s
EVENT create-archive-8

real	0m31.280s
user	0m11.723s
sys	0m9.229s
EVENT distribute-all-nodes-8

real	0m24.499s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-8

real	0m37.997s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-8

real	0m0.037s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-8

real	0m31.931s
user	0m11.779s
sys	0m9.367s
EVENT distribute-leaf-nodes-8

real	0m24.161s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-8

real	0m38.064s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-8

real	0m0.036s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-8

real	0m32.202s
user	0m11.790s
sys	0m9.557s
EVENT distribute-middle-nodes-0-8

real	0m23.333s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-8

real	0m23.222s
user	0m0.001s
sys	0m0.006s
EVENT clean-middle-nodes-8

real	0m2.475s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-8

real	0m0.036s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-9

real	0m35.551s
user	0m13.301s
sys	0m10.253s
EVENT distribute-all-nodes-9

real	0m27.370s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-9

real	0m36.002s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-9

real	0m0.039s
user	0m0.004s
sys	0m0.003s
EVENT create-leaf-nodes-9

real	0m35.707s
user	0m13.341s
sys	0m10.368s
EVENT distribute-leaf-nodes-9

real	0m26.781s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-9

real	0m36.557s
user	0m0.004s
sys	0m0.003s
EVENT delete-archive-leaf-nodes-9

real	0m0.039s
user	0m0.003s
sys	0m0.004s
EVENT create-middle-nodes-9

real	0m36.317s
user	0m13.410s
sys	0m10.794s
EVENT distribute-middle-nodes-0-9

real	0m26.786s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-9

real	0m27.806s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-9

real	0m13.961s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-middle-nodes-9

real	0m0.039s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-10

real	0m38.899s
user	0m14.660s
sys	0m11.334s
EVENT distribute-all-nodes-10

real	0m31.084s
user	0m0.001s
sys	0m0.006s
EVENT clean-all-nodes-10

real	0m43.429s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-10

real	0m0.041s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-10

real	0m38.873s
user	0m14.517s
sys	0m11.381s
EVENT distribute-leaf-nodes-10

real	0m30.477s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-10

real	0m2.865s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-10

real	0m0.041s
user	0m0.001s
sys	0m0.007s
EVENT create-middle-nodes-10

real	0m39.989s
user	0m14.738s
sys	0m11.689s
EVENT distribute-middle-nodes-0-10

real	0m29.545s
user	0m0.005s
sys	0m0.002s
EVENT distribute-middle-nodes-1-10

real	0m30.940s
user	0m0.003s
sys	0m0.004s
EVENT clean-middle-nodes-10

real	0m13.763s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-10

real	0m0.040s
user	0m0.002s
sys	0m0.005s
SCRIPT entrypoint

#!/bin/bash
# flux-topology.sh

flux exec -r all flux module reload content purge-target-size=104857600 # 100mb
echo "MODULE STATS CONTENT"
flux module stats content | jq

# Print the overlay to show the topology
echo "NODES"
echo "6"
echo "TOPOLOGY diagram"
flux overlay status
echo "TOPOLOGY description"
echo "binomial"

# Go up to 10 sizes for now (matches container size)
for size in $(seq 1 10)
  do
    # Create the archive and time it
    echo "EVENT create-archive-${size}"
    time flux archive create --name create-archive-${size} --dir /chonks ${size}gb.txt

    # Distribute to all nodes, but to /tmp because file exists in /chonks
    echo "EVENT distribute-all-nodes-${size}"
    time flux exec -r all -x 0 flux archive extract --name create-archive-${size} -C /tmp

    # Cleanup all archive on all nodes
    echo "EVENT clean-all-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt

    echo "EVENT delete-archive-all-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-${size} 2>/dev/null

    # Next, do the same for the root node (level 0) to the deepest level (leaves)
    echo "EVENT create-leaf-nodes-${size}"
    time flux archive create --name create-archive-leaves-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-leaf-nodes-${size}"
    time flux exec -r 3,5 -x 0 flux archive extract --name create-archive-leaves-${size} -C /tmp
    # Cleanup again    
    echo "EVENT clean-leaf-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-leaf-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-leaves-${size} 2>/dev/null

    # Finally, get the middle node and distribute to middle level first, then middle to last
    echo "EVENT create-middle-nodes-${size}"
    time flux archive create --name create-archive-middle-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-middle-nodes-0-${size}"
    time flux exec -r 1,2,4 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT distribute-middle-nodes-1-${size}"
    time flux exec -r 3,5 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT clean-middle-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-middle-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-middle-${size} 2>/dev/null
done

# Show self!
echo "SCRIPT entrypoint"
cat $0