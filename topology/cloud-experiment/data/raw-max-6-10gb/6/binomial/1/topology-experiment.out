[1;31merror[0m: [1mexternally-managed-environment[0m

[31mÃ—[0m This environment is externally managed
[31mâ•°â”€>[0m To install Python packages system-wide, try apt install
[31m   [0m python3-xyz, where xyz is the package you are trying to
[31m   [0m install.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian-packaged Python package,
[31m   [0m create a virtual environment using python3 -m venv path/to/venv.
[31m   [0m Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
[31m   [0m sure you have python3-full installed.
[31m   [0m 
[31m   [0m If you wish to install a non-Debian packaged Python application,
[31m   [0m it may be easiest to use pipx install xyz, which will manage a
[31m   [0m virtual environment for you. Make sure you have pipx installed.
[31m   [0m 
[31m   [0m See /usr/share/doc/python3.12/README.venv for more information.

[1;35mnote[0m: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
[1;36mhint[0m: See PEP 668 for the detailed specification.
MODULE STATS CONTENT
[1;39m{
  [0m[1;34m"count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"valid"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"dirty"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"size"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"flush-batch-count"[0m[1;39m: [0m[0;39m0[0m[1;39m,
  [0m[1;34m"mmap"[0m[1;39m: [0m[1;39m{
    [0m[1;34m"tags"[0m[1;39m: [0m[1;39m{}[0m[1;39m,
    [0m[1;34m"blobs"[0m[1;39m: [0m[0;39m0[0m[1;39m
  [1;39m}[0m[1;39m
[1;39m}[0m
NODES
6
TOPOLOGY diagram
0 flux-sample-0: full
â”œâ”€ 1 flux-sample-1: full
â”œâ”€ 2 flux-sample-2: full
â”‚  â””â”€ 3 flux-sample-3: full
â””â”€ 4 flux-sample-4: full
   â””â”€ 5 flux-sample-5: full
TOPOLOGY description
binomial
EVENT create-archive-1

real	0m4.005s
user	0m1.490s
sys	0m1.136s
EVENT distribute-all-nodes-1

real	0m2.666s
user	0m0.001s
sys	0m0.006s
EVENT clean-all-nodes-1

real	0m0.308s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-1

real	0m0.020s
user	0m0.000s
sys	0m0.006s
EVENT create-leaf-nodes-1

real	0m3.978s
user	0m1.432s
sys	0m1.202s
EVENT distribute-leaf-nodes-1

real	0m2.530s
user	0m0.002s
sys	0m0.004s
EVENT clean-leaf-nodes-1

real	0m0.304s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-1

real	0m0.020s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-1

real	0m4.005s
user	0m1.487s
sys	0m1.196s
EVENT distribute-middle-nodes-0-1

real	0m2.694s
user	0m0.000s
sys	0m0.006s
EVENT distribute-middle-nodes-1-1

real	0m2.627s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-1

real	0m0.308s
user	0m0.000s
sys	0m0.007s
EVENT delete-archive-middle-nodes-1

real	0m0.019s
user	0m0.000s
sys	0m0.006s
EVENT create-archive-2

real	0m8.026s
user	0m2.971s
sys	0m2.360s
EVENT distribute-all-nodes-2

real	0m5.336s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-2

real	0m0.589s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-2

real	0m0.021s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-2

real	0m7.765s
user	0m2.996s
sys	0m2.168s
EVENT distribute-leaf-nodes-2

real	0m5.248s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-2

real	0m0.591s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-2

real	0m0.022s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-2

real	0m7.959s
user	0m2.969s
sys	0m2.327s
EVENT distribute-middle-nodes-0-2

real	0m5.222s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-2

real	0m5.225s
user	0m0.001s
sys	0m0.005s
EVENT clean-middle-nodes-2

real	0m7.546s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-2

real	0m0.022s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-3

real	0m11.630s
user	0m4.368s
sys	0m3.415s
EVENT distribute-all-nodes-3

real	0m7.792s
user	0m0.004s
sys	0m0.004s
EVENT clean-all-nodes-3

real	0m0.877s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-all-nodes-3

real	0m0.026s
user	0m0.002s
sys	0m0.005s
EVENT create-leaf-nodes-3

real	0m11.854s
user	0m4.465s
sys	0m3.443s
EVENT distribute-leaf-nodes-3

real	0m7.817s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-3

real	0m0.861s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-3

real	0m0.026s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-3

real	0m12.003s
user	0m4.526s
sys	0m3.506s
EVENT distribute-middle-nodes-0-3

real	0m7.886s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-3

real	0m8.134s
user	0m0.003s
sys	0m0.004s
EVENT clean-middle-nodes-3

real	0m14.672s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-3

real	0m0.027s
user	0m0.002s
sys	0m0.005s
EVENT create-archive-4

real	0m16.027s
user	0m5.711s
sys	0m4.942s
EVENT distribute-all-nodes-4

real	0m10.683s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-4

real	0m1.157s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-all-nodes-4

real	0m0.028s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-4

real	0m15.975s
user	0m5.943s
sys	0m4.676s
EVENT distribute-leaf-nodes-4

real	0m10.297s
user	0m0.002s
sys	0m0.005s
EVENT clean-leaf-nodes-4

real	0m21.391s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-4

real	0m0.030s
user	0m0.003s
sys	0m0.004s
EVENT create-middle-nodes-4

real	0m15.559s
user	0m5.888s
sys	0m4.506s
EVENT distribute-middle-nodes-0-4

real	0m10.531s
user	0m0.001s
sys	0m0.006s
EVENT distribute-middle-nodes-1-4

real	0m10.308s
user	0m0.002s
sys	0m0.004s
EVENT clean-middle-nodes-4

real	0m1.166s
user	0m0.000s
sys	0m0.007s
EVENT delete-archive-middle-nodes-4

real	0m0.028s
user	0m0.000s
sys	0m0.006s
EVENT create-archive-5

real	0m20.081s
user	0m7.483s
sys	0m5.854s
EVENT distribute-all-nodes-5

real	0m13.613s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-5

real	0m1.669s
user	0m0.005s
sys	0m0.003s
EVENT delete-archive-all-nodes-5

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-leaf-nodes-5

real	0m19.980s
user	0m7.481s
sys	0m5.745s
EVENT distribute-leaf-nodes-5

real	0m13.083s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-5

real	0m1.426s
user	0m0.004s
sys	0m0.003s
EVENT delete-archive-leaf-nodes-5

real	0m0.031s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-5

real	0m20.040s
user	0m7.381s
sys	0m5.948s
EVENT distribute-middle-nodes-0-5

real	0m13.318s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-5

real	0m14.011s
user	0m0.000s
sys	0m0.007s
EVENT clean-middle-nodes-5

real	0m1.562s
user	0m0.000s
sys	0m0.007s
EVENT delete-archive-middle-nodes-5

real	0m0.032s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-6

real	0m23.217s
user	0m8.913s
sys	0m6.569s
EVENT distribute-all-nodes-6

real	0m17.246s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-6

real	0m33.371s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-6

real	0m0.034s
user	0m0.003s
sys	0m0.005s
EVENT create-leaf-nodes-6

real	0m23.527s
user	0m8.769s
sys	0m6.917s
EVENT distribute-leaf-nodes-6

real	0m15.625s
user	0m0.000s
sys	0m0.006s
EVENT clean-leaf-nodes-6

real	0m1.726s
user	0m0.004s
sys	0m0.003s
EVENT delete-archive-leaf-nodes-6

real	0m0.033s
user	0m0.003s
sys	0m0.004s
EVENT create-middle-nodes-6

real	0m23.948s
user	0m8.911s
sys	0m7.159s
EVENT distribute-middle-nodes-0-6

real	0m17.249s
user	0m0.004s
sys	0m0.003s
EVENT distribute-middle-nodes-1-6

real	0m17.526s
user	0m0.001s
sys	0m0.006s
EVENT clean-middle-nodes-6

real	0m25.519s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-6

real	0m0.033s
user	0m0.001s
sys	0m0.006s
EVENT create-archive-7

real	0m27.963s
user	0m10.381s
sys	0m8.249s
EVENT distribute-all-nodes-7

real	0m20.618s
user	0m0.002s
sys	0m0.006s
EVENT clean-all-nodes-7

real	0m35.964s
user	0m0.004s
sys	0m0.004s
EVENT delete-archive-all-nodes-7

real	0m0.035s
user	0m0.004s
sys	0m0.004s
EVENT create-leaf-nodes-7

real	0m27.502s
user	0m10.353s
sys	0m7.968s
EVENT distribute-leaf-nodes-7

real	0m18.810s
user	0m0.001s
sys	0m0.006s
EVENT clean-leaf-nodes-7

real	0m37.916s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-7

real	0m0.035s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-7

real	0m27.460s
user	0m10.344s
sys	0m7.996s
EVENT distribute-middle-nodes-0-7

real	0m20.966s
user	0m0.003s
sys	0m0.004s
EVENT distribute-middle-nodes-1-7

real	0m20.750s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-7

real	0m31.175s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-7

real	0m0.035s
user	0m0.004s
sys	0m0.004s
EVENT create-archive-8

real	0m31.320s
user	0m11.480s
sys	0m9.386s
EVENT distribute-all-nodes-8

real	0m24.059s
user	0m0.002s
sys	0m0.005s
EVENT clean-all-nodes-8

real	0m38.310s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-all-nodes-8

real	0m0.037s
user	0m0.003s
sys	0m0.005s
EVENT create-leaf-nodes-8

real	0m31.577s
user	0m11.556s
sys	0m9.535s
EVENT distribute-leaf-nodes-8

real	0m22.505s
user	0m0.001s
sys	0m0.006s
EVENT clean-leaf-nodes-8

real	0m2.606s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-leaf-nodes-8

real	0m0.036s
user	0m0.001s
sys	0m0.006s
EVENT create-middle-nodes-8

real	0m31.530s
user	0m11.801s
sys	0m9.267s
EVENT distribute-middle-nodes-0-8

real	0m24.587s
user	0m0.002s
sys	0m0.005s
EVENT distribute-middle-nodes-1-8

real	0m24.160s
user	0m0.003s
sys	0m0.003s
EVENT clean-middle-nodes-8

real	0m32.934s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-middle-nodes-8

real	0m0.037s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-9

real	0m35.031s
user	0m13.416s
sys	0m9.957s
EVENT distribute-all-nodes-9

real	0m27.446s
user	0m0.001s
sys	0m0.006s
EVENT clean-all-nodes-9

real	0m41.282s
user	0m0.003s
sys	0m0.005s
EVENT delete-archive-all-nodes-9

real	0m0.039s
user	0m0.003s
sys	0m0.004s
EVENT create-leaf-nodes-9

real	0m35.607s
user	0m13.302s
sys	0m10.597s
EVENT distribute-leaf-nodes-9

real	0m27.283s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-9

real	0m2.581s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-leaf-nodes-9

real	0m0.039s
user	0m0.004s
sys	0m0.004s
EVENT create-middle-nodes-9

real	0m35.547s
user	0m13.123s
sys	0m10.660s
EVENT distribute-middle-nodes-0-9

real	0m26.381s
user	0m0.003s
sys	0m0.004s
EVENT distribute-middle-nodes-1-9

real	0m27.254s
user	0m0.002s
sys	0m0.005s
EVENT clean-middle-nodes-9

real	0m14.817s
user	0m0.002s
sys	0m0.005s
EVENT delete-archive-middle-nodes-9

real	0m0.039s
user	0m0.003s
sys	0m0.004s
EVENT create-archive-10

real	0m39.753s
user	0m14.812s
sys	0m11.803s
EVENT distribute-all-nodes-10

real	0m31.392s
user	0m0.003s
sys	0m0.004s
EVENT clean-all-nodes-10

real	0m3.082s
user	0m0.001s
sys	0m0.006s
EVENT delete-archive-all-nodes-10

real	0m0.041s
user	0m0.001s
sys	0m0.006s
EVENT create-leaf-nodes-10

real	0m39.854s
user	0m14.862s
sys	0m11.666s
EVENT distribute-leaf-nodes-10

real	0m31.109s
user	0m0.003s
sys	0m0.004s
EVENT clean-leaf-nodes-10

real	0m37.796s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-leaf-nodes-10

real	0m0.041s
user	0m0.002s
sys	0m0.005s
EVENT create-middle-nodes-10

real	0m40.251s
user	0m14.848s
sys	0m11.870s
EVENT distribute-middle-nodes-0-10

real	0m30.828s
user	0m0.000s
sys	0m0.007s
EVENT distribute-middle-nodes-1-10

real	0m30.347s
user	0m0.001s
sys	0m0.006s
EVENT clean-middle-nodes-10

real	0m44.116s
user	0m0.003s
sys	0m0.004s
EVENT delete-archive-middle-nodes-10

real	0m0.041s
user	0m0.002s
sys	0m0.005s
SCRIPT entrypoint

#!/bin/bash
# flux-topology.sh

flux exec -r all flux module reload content purge-target-size=104857600 # 100mb
echo "MODULE STATS CONTENT"
flux module stats content | jq

# Print the overlay to show the topology
echo "NODES"
echo "6"
echo "TOPOLOGY diagram"
flux overlay status
echo "TOPOLOGY description"
echo "binomial"

# Go up to 10 sizes for now (matches container size)
for size in $(seq 1 10)
  do
    # Create the archive and time it
    echo "EVENT create-archive-${size}"
    time flux archive create --name create-archive-${size} --dir /chonks ${size}gb.txt

    # Distribute to all nodes, but to /tmp because file exists in /chonks
    echo "EVENT distribute-all-nodes-${size}"
    time flux exec -r all -x 0 flux archive extract --name create-archive-${size} -C /tmp

    # Cleanup all archive on all nodes
    echo "EVENT clean-all-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt

    echo "EVENT delete-archive-all-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-${size} 2>/dev/null

    # Next, do the same for the root node (level 0) to the deepest level (leaves)
    echo "EVENT create-leaf-nodes-${size}"
    time flux archive create --name create-archive-leaves-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-leaf-nodes-${size}"
    time flux exec -r 3,5 -x 0 flux archive extract --name create-archive-leaves-${size} -C /tmp
    # Cleanup again    
    echo "EVENT clean-leaf-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-leaf-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-leaves-${size} 2>/dev/null

    # Finally, get the middle node and distribute to middle level first, then middle to last
    echo "EVENT create-middle-nodes-${size}"
    time flux archive create --name create-archive-middle-${size} --dir /chonks ${size}gb.txt
    echo "EVENT distribute-middle-nodes-0-${size}"
    time flux exec -r 1,2,4 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT distribute-middle-nodes-1-${size}"
    time flux exec -r 3,5 -x 0 flux archive extract --name create-archive-middle-${size} -C /tmp
    echo "EVENT clean-middle-nodes-${size}"
    time flux exec -r all rm -rf /tmp/${size}gb.txt
    echo "EVENT delete-archive-middle-nodes-${size}"
    time flux exec -r all flux archive remove --name create-archive-middle-${size} 2>/dev/null
done

# Show self!
echo "SCRIPT entrypoint"
cat $0